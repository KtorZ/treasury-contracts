import { Core } from "@blaze-cardano/sdk";
import { describe, expect, it } from "bun:test";
import {
  fromTxMetadata,
  ITransactionMetadata,
  toTxMetadata,
} from "../../src/metadata/shared.js";

const exampleMetadata: ITransactionMetadata = {
  "@context": "example",
  hashAlgorithm: "blake2b-256",
  body: {
    event: "publish",
    expiration: 200n,
    payoutUpperbound: 200n,
    vendorExpiration: 200n,
    identifier: "custom",
    permissions: {
      disburse: {
        signature: {
          key_hash: "123",
        },
      },
      fund: {
        signature: {
          key_hash: "123",
        },
      },
      modify: {
        signature: {
          key_hash: "123",
        },
      },
      pause: {
        signature: {
          key_hash: "123",
        },
      },
      reorganize: {
        signature: {
          key_hash: "123",
        },
      },
      resume: {
        signature: {
          key_hash: "123",
        },
      },
      sweep: {
        signature: {
          key_hash: "123",
        },
      },
    },
    txAuthor: "123456",
    comment: "Example comment",
    description: "Example description goes here.",
    label: "example lable",
  },
};

describe("toMetadata", () => {
  it("should correctly convert to cbor", () => {
    const result = toTxMetadata(exampleMetadata);
    expect(result.toCbor()).toEqual(
      Core.HexBlob(
        "a119069ea36840636f6e74657874676578616d706c656d68617368416c676f726974686d6b626c616b6532622d32353664626f6479aa656576656e74677075626c6973686a65787069726174696f6e18c8707061796f75745570706572626f756e6418c87076656e646f7245787069726174696f6e18c86a6964656e74696669657266637573746f6d6b7065726d697373696f6e73a7686469736275727365a1697369676e6174757265a1686b65795f68617368633132336466756e64a1697369676e6174757265a1686b65795f6861736863313233666d6f64696679a1697369676e6174757265a1686b65795f6861736863313233657061757365a1697369676e6174757265a1686b65795f68617368633132336a72656f7267616e697a65a1697369676e6174757265a1686b65795f686173686331323366726573756d65a1697369676e6174757265a1686b65795f6861736863313233657377656570a1697369676e6174757265a1686b65795f6861736863313233687478417574686f726631323334353667636f6d6d656e746f4578616d706c6520636f6d6d656e746b6465736372697074696f6e781e4578616d706c65206465736372697074696f6e20676f657320686572652e656c6162656c6d6578616d706c65206c61626c65",
      ),
    );
  });
});

describe("fromMetadata", () => {
  it("should convert it to an object", async () => {
    const metadata = Core.Metadata.fromCbor(
      Core.HexBlob(
        "a119069ea36840636f6e74657874676578616d706c656d68617368416c676f726974686d6b626c616b6532622d32353664626f6479aa656576656e74677075626c6973686a65787069726174696f6e18c8707061796f75745570706572626f756e6418c87076656e646f7245787069726174696f6e18c86a6964656e74696669657266637573746f6d6b7065726d697373696f6e73a7686469736275727365a1697369676e6174757265a1686b65795f68617368633132336466756e64a1697369676e6174757265a1686b65795f6861736863313233666d6f64696679a1697369676e6174757265a1686b65795f6861736863313233657061757365a1697369676e6174757265a1686b65795f68617368633132336a72656f7267616e697a65a1697369676e6174757265a1686b65795f686173686331323366726573756d65a1697369676e6174757265a1686b65795f6861736863313233657377656570a1697369676e6174757265a1686b65795f6861736863313233687478417574686f726631323334353667636f6d6d656e746f4578616d706c6520636f6d6d656e746b6465736372697074696f6e781e4578616d706c65206465736372697074696f6e20676f657320686572652e656c6162656c6d6578616d706c65206c61626c65",
      ),
    );

    const result = await fromTxMetadata(metadata);
    expect(result).toMatchObject(exampleMetadata);
  });
});
