import { Core } from "@blaze-cardano/sdk";
import { describe, expect, it } from "bun:test";
import {
  fromTxMetadata,
  ITransactionMetadata,
  toTxMetadata,
} from "src/metadata/shared";
import { INewInstance } from "src/metadata/types/new-instance";

const exampleMetadata: ITransactionMetadata<INewInstance> = {
  body: {
    event: "publish",
    label: "Sample Instance 12",
    seed_utxo: {
      output_index: 1n,
      transaction_id:
        "bee1ae94e4ab00990cb15ea38b141a3335f36dacc0d5642224be5dfa40a1b4dd",
    },
    expiration: 1767243600000n,
    description: "Testing new indexing code!",
    permissions: {
      fund: "reorganize",
      pause: "reorganize",
      sweep: "reorganize",
      modify: "reorganize",
      resume: "reorganize",
      disburse: "reorganize",
      reorganize: {
        label: "Pi",
        signature: {
          key_hash: "c279a3fb3b4e62bbc78e288783b58045d4ae82a18867d8352d02775a",
        },
      },
    },
    payoutUpperbound: 1772341200000n,
    vendorExpiration: 1780286400000n,
  },
  "@context": "sundae.fi/sample-context",
  instance: "70440eb757486c4db15559d0c1b2699c20a4a28b5c65585d54689c30",
  txAuthor: "c279a3fb3b4e62bbc78e288783b58045d4ae82a18867d8352d02775a",
  hashAlgorithm: "blake2b-256",
};

describe("toMetadata", () => {
  it("should correctly convert to cbor", () => {
    const result = toTxMetadata(exampleMetadata);
    expect(result.toCbor()).toEqual(
      Core.HexBlob(
        "a119069ea56840636f6e74657874781873756e6461652e66692f73616d706c652d636f6e746578746d68617368416c676f726974686d6b626c616b6532622d323536687478417574686f727838633237396133666233623465363262626337386532383837383362353830343564346165383261313838363764383335326430323737356168696e7374616e63657838373034343065623735373438366334646231353535396430633162323639396332306134613238623563363535383564353436383963333064626f6479a8656576656e74677075626c697368656c6162656c7253616d706c6520496e7374616e636520313269736565645f7574786fa26c6f75747075745f696e646578016e7472616e73616374696f6e5f69647840626565316165393465346162303039393063623135656133386231343161333333356633366461636330643536343232323462653564666134306131623464646a65787069726174696f6e1b0000019b77ed50806b6465736372697074696f6e781a54657374696e67206e657720696e646578696e6720636f6465216b7065726d697373696f6e73a76466756e646a72656f7267616e697a656570617573656a72656f7267616e697a656573776565706a72656f7267616e697a65666d6f646966796a72656f7267616e697a6566726573756d656a72656f7267616e697a656864697362757273656a72656f7267616e697a656a72656f7267616e697a65a2656c6162656c625069697369676e6174757265a1686b65795f6861736878386332373961336662336234653632626263373865323838373833623538303435643461653832613138383637643833353264303237373561707061796f75745570706572626f756e641b0000019ca7c484807076656e646f7245787069726174696f6e1b0000019e8156a600",
      ),
    );
  });
});

describe("fromMetadata", () => {
  it("should convert it to an object", async () => {
    const metadata = Core.Metadata.fromCbor(
      Core.HexBlob(
        "a119069ea56840636f6e74657874781873756e6461652e66692f73616d706c652d636f6e746578746d68617368416c676f726974686d6b626c616b6532622d323536687478417574686f727838633237396133666233623465363262626337386532383837383362353830343564346165383261313838363764383335326430323737356168696e7374616e63657838373034343065623735373438366334646231353535396430633162323639396332306134613238623563363535383564353436383963333064626f6479a8656576656e74677075626c697368656c6162656c7253616d706c6520496e7374616e636520313269736565645f7574786fa26c6f75747075745f696e646578016e7472616e73616374696f6e5f69647840626565316165393465346162303039393063623135656133386231343161333333356633366461636330643536343232323462653564666134306131623464646a65787069726174696f6e1b0000019b77ed50806b6465736372697074696f6e781a54657374696e67206e657720696e646578696e6720636f6465216b7065726d697373696f6e73a76466756e646a72656f7267616e697a656570617573656a72656f7267616e697a656573776565706a72656f7267616e697a65666d6f646966796a72656f7267616e697a6566726573756d656a72656f7267616e697a656864697362757273656a72656f7267616e697a656a72656f7267616e697a65a2656c6162656c625069697369676e6174757265a1686b65795f6861736878386332373961336662336234653632626263373865323838373833623538303435643461653832613138383637643833353264303237373561707061796f75745570706572626f756e641b0000019ca7c484807076656e646f7245787069726174696f6e1b0000019e8156a600",
      ),
    );

    const result = await fromTxMetadata(metadata);
    expect(result).toMatchObject(exampleMetadata);
  });
});
